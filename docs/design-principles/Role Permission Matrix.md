# 角色權限對應表 (Role Permission Matrix)

## 概述

角色權限對應表定義了營建管理系統中不同角色的權限範圍，確保系統的安全性和資料存取控制。

## 角色定義

### 1. 系統角色
- **系統管理員** (System Admin): 最高權限，管理整個系統
- **組織管理員** (Organization Admin): 管理組織內的所有資源
- **專案經理** (Project Manager): 管理專案和團隊
- **工程師** (Engineer): 執行專案任務
- **監工** (Supervisor): 監督施工進度
- **承包商** (Contractor): 執行具體施工工作
- **一般用戶** (User): 基本查看權限

### 2. 專案角色
- **專案擁有者** (Project Owner): 專案的創建者和最高管理者
- **專案管理員** (Project Admin): 專案的管理者
- **團隊隊長** (Team Lead): 團隊的領導者
- **團隊成員** (Team Member): 團隊的普通成員
- **觀察者** (Observer): 只能查看專案資訊

## 權限矩陣

### 帳戶模組權限

| 功能 | 系統管理員 | 組織管理員 | 專案經理 | 工程師 | 監工 | 承包商 | 一般用戶 |
|------|------------|------------|----------|--------|------|--------|----------|
| 用戶管理 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 組織管理 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 個人檔案管理 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 社交功能 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 成就系統 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 通知管理 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

### 組織模組權限

| 功能 | 系統管理員 | 組織管理員 | 專案經理 | 工程師 | 監工 | 承包商 | 一般用戶 |
|------|------------|------------|----------|--------|------|--------|----------|
| 建立組織 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 管理組織資料 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 邀請成員 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 管理團隊 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 分配專案 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 查看組織資訊 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

### 專案模組權限

| 功能 | 專案擁有者 | 專案管理員 | 團隊隊長 | 團隊成員 | 觀察者 |
|------|------------|------------|----------|----------|--------|
| 建立專案 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 編輯專案資訊 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 刪除專案 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 管理里程碑 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 建立任務 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 分配任務 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 執行任務 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 管理團隊成員 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 上傳文件 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 查看專案 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 成本控制 | ✅ | ✅ | ❌ | ❌ | ❌ |

## 細粒度權限

### 資料存取權限

| 資料類型 | 系統管理員 | 組織管理員 | 專案經理 | 工程師 | 監工 | 承包商 | 一般用戶 |
|----------|------------|------------|----------|--------|------|--------|----------|
| 用戶資料 | 全部 | 組織內 | 團隊內 | 自己 | 自己 | 自己 | 自己 |
| 專案資料 | 全部 | 組織內 | 分配專案 | 分配專案 | 分配專案 | 分配專案 | 公開專案 |
| 財務資料 | 全部 | 組織內 | 專案內 | ❌ | ❌ | ❌ | ❌ |
| 系統設定 | 全部 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

### 操作權限

| 操作類型 | 系統管理員 | 組織管理員 | 專案經理 | 工程師 | 監工 | 承包商 | 一般用戶 |
|----------|------------|------------|----------|--------|------|--------|----------|
| 建立 | 全部 | 組織內 | 專案內 | 任務 | 任務 | 任務 | ❌ |
| 讀取 | 全部 | 組織內 | 專案內 | 分配任務 | 分配任務 | 分配任務 | 公開資料 |
| 更新 | 全部 | 組織內 | 專案內 | 分配任務 | 分配任務 | 分配任務 | 個人資料 |
| 刪除 | 全部 | 組織內 | 專案內 | ❌ | ❌ | ❌ | ❌ |

## 權限繼承

### 角色繼承關係
```
系統管理員
├── 組織管理員
│   ├── 專案經理
│   │   ├── 團隊隊長
│   │   └── 團隊成員
│   └── 工程師
├── 監工
└── 承包商
```

### 權限繼承規則
1. **向上繼承**: 高級角色自動擁有低級角色的權限
2. **向下限制**: 低級角色不能擁有高級角色的權限
3. **橫向隔離**: 同級角色之間不能互相存取資料
4. **特殊權限**: 某些權限需要明確授予

## 動態權限

### 專案級權限
- **專案擁有者**: 擁有專案的所有權限
- **專案管理員**: 由專案擁有者指定
- **團隊隊長**: 由專案管理員指定
- **團隊成員**: 由團隊隊長邀請
- **觀察者**: 由專案管理員指定

### 臨時權限
- **緊急權限**: 在緊急情況下授予的臨時權限
- **委派權限**: 臨時委派給其他用戶的權限
- **過期權限**: 設定過期時間的權限

## 權限檢查

### 權限檢查流程
```typescript
// 權限檢查範例
class PermissionService {
  hasPermission(user: User, resource: string, action: string): boolean {
    // 1. 檢查用戶角色
    if (this.hasRolePermission(user.roles, resource, action)) {
      return true;
    }
    
    // 2. 檢查專案級權限
    if (this.hasProjectPermission(user, resource, action)) {
      return true;
    }
    
    // 3. 檢查動態權限
    if (this.hasDynamicPermission(user, resource, action)) {
      return true;
    }
    
    return false;
  }
  
  private hasRolePermission(roles: string[], resource: string, action: string): boolean {
    return roles.some(role => 
      this.rolePermissions[role]?.[resource]?.includes(action)
    );
  }
}
```

### 權限快取
- **角色權限快取**: 快取用戶的角色權限
- **專案權限快取**: 快取用戶的專案權限
- **動態權限快取**: 快取動態授予的權限
- **權限失效**: 權限變更時清除相關快取

## 安全考量

### 權限驗證
- **前端驗證**: 提供良好的用戶體驗
- **後端驗證**: 確保資料安全
- **API 權限**: 每個 API 端點都要驗證權限
- **資料庫權限**: 資料庫層面的存取控制

### 權限審計
- **操作記錄**: 記錄所有權限相關的操作
- **權限變更**: 記錄權限的授予和撤銷
- **異常存取**: 監控異常的存取行為
- **定期審查**: 定期審查用戶權限

## 最佳實踐

### 權限設計原則
1. **最小權限原則**: 只授予必要的權限
2. **職責分離**: 不同角色承擔不同職責
3. **權限繼承**: 合理設計權限繼承關係
4. **動態調整**: 支援權限的動態調整

### 實施建議
1. **角色設計**: 根據業務需求設計角色
2. **權限細化**: 提供細粒度的權限控制
3. **權限測試**: 充分測試權限邏輯
4. **文檔維護**: 及時更新權限文檔
